lines(ma6, col="salmon", lwd=2)
lines(ma30, col="skyblue3", lwd=2)
legend("topleft", legend = c("x", "MA(6) Smoothing", "MA(30) Smoothing"),
lty = 1, col=c("black", "salmon", "skyblue3"), bty = "n")
# using MA(30) here
# inputs for quadratic function
t_valid <- t[!is.na(ma30)]
y_valid <- ma30[!is.na(ma30)]
# fit quadratic function
quad <- lm(y_valid ~ t_valid + I(t_valid^2))
# true function
g_t <- (1-t_valid/100)^2
# predictions using quadratic model
g_hat <- fitted(quad)
# plot
plot(t_valid, y_valid, type = "l", col = "skyblue3", lwd = 2,
ylab = "Value", xlab = "Time", main = "Quadratic Fit vs True Curve")
lines(t_valid, g_t, col = "deeppink3", lwd = 2)
lines(t_valid, g_hat, col = "goldenrod1", lwd = 2)
legend("topleft", legend = c("MA(30)", "True Function (g(t))", "Fitted quadratic"),
col = c("skyblue3", "deeppink3", "goldenrod1"), lwd = 2)
# plot
tsplot(cbind(oil, gas), spaghetti = TRUE,
col = astsa.col(c(4,6)), pch = c(20,18), type="l", ylab="Price", xlab="Time", lwd=1,
main = "Oil and Gas Series", addLegend = TRUE,
location = "topleft", legend = c("oil (dollars/barrel)", "gas (cents/gallon)"))
Ot <- diff(sqrt(oil))
Gt <- diff(sqrt(gas))
tsplot(cbind(Ot, Gt), spaghetti = TRUE,
col = astsa.col(c(4,6)), pch = c(20,18), type="l", ylab="Price", xlab="Time", lwd=1,
main = "Transformed Oil and Gas Series", addLegend = TRUE,
location = "topleft", legend = c("oil (dollars/barrel)", "gas (cents/gallon)"))
acf(Ot, lag.max=50)
acf(Gt, lag.max=50)
ccf(Ot, Gt, lag.max=50)
knitr::opts_chunk$set(echo = TRUE)
library(astsa)
x <- cmort
(regr = ar.ols(rec, order=2, demean=FALSE, intercept=TRUE))
regr$asy.se.coef #standard errors of the estimates
predict(reg, n.ahead=4)
x <- cmort
(reg = ar.ols(cmort, order=2, demean=FALSE, intercept=TRUE))
reg$asy.se.coef #standard errors of the estimates
predict(reg, n.ahead=4)
x <- cmort
(reg = ar.ols(x, order=2, demean=FALSE, intercept=TRUE))
reg$asy.se.coef #standard errors of the estimates
predict(reg, n.ahead=4)
acf(oil)
plot(oil)
acf(oil)
plot(oil)
acf(oil, lag.max=20)
plot(oil)
acf(oil, lag.max=50)
plot(oil)
acf(oil)
plot(oil)
acf2(oil)
plot(oil)
acf2(oil)
# these plots show that the data is non-stationary ==> need differencing
#difference the data
d_oil <- diff(oil)
plot(d_oil)
acf2(d_oil)
plot(oil)
acf2(oil)
# these plots show that the data is non-stationary ==> need differencing
#difference the data
d_oil <- diff(log(oil))
plot(d_oil)
acf2(d_oil)
# the AR order is
plot(oil)
acf2(oil)
# these plots show that the data is non-stationary ==> need differencing
#difference the data
d_oil <- diff(log(oil))
plot(d_oil)
acf2(d_oil)
aic(d_oil)
plot(oil)
acf2(oil)
# these plots show that the data is non-stationary ==> need differencing
#difference the data
d_oil <- diff(log(oil))
plot(d_oil)
acf2(d_oil)
# these are either ARMA(1,1) or ARMA(0,3)
#ARIMA
sarima(d_oil, 1, 0, 1)
sarima(d_oil, 0, 0, 3)
plot(oil)
acf2(oil)
# these plots show that the data is non-stationary ==> need differencing
#difference the data
d_oil <- diff(log(oil))
plot(d_oil)
acf2(d_oil)
# these are either ARMA(1,1) or ARMA(0,3)
#ARIMA
sarima(d_oil, 1, 0, 1)
sarima(d_oil, 0, 0, 3)
plot(chicken)
acf2(chicken)
plot(chicken)
acf2(chicken)
# data is non-stationary and has long-term dependency
d_chicken <- diff(chicken)
plot(d_chicken)
acf2(d_chicken)
sarima(chicken, 2, 1,0)
sarima(chicken, 2, 1, 0, 1, 0, 0, 12, no.constant=TRUE) #AR(2) and seasonal AR(1)
sarima(chicken, 2, 1, 0, 0, 0, 0, 12, np.constant=TRUE) #AR(2)
sarima(chicken, 2, 1, 0, 1, 0, 0, 12, no.constant=TRUE) #AR(2) and seasonal AR(1)
sarima(chicken, 2, 1, 0, 0, 0, 0, 12, no.constant=TRUE) #AR(2)
setwd("~/Desktop/classes/MSDAS_Practicum/msdas_practicum-project")
knitr::opts_chunk$set(echo = TRUE)
library(astsa) # for ARIMA modelling
library(data.table)
library(dplyr)
library(forecast)
setwd("~/Desktop/classes/MSDAS_Practicum/msdas_practicum-project")
knitr::opts_chunk$set(echo = TRUE)
library(astsa) # for ARIMA modelling
library(data.table)
library(dplyr)
library(forecast)
installed.packages()
install.packages("forecast")
library(astsa) # for ARIMA modelling
library(data.table)
library(dplyr)
library(forecast)
install.packages("forecast")
install.packages("tseries")
install.packages("forecast", type = "binary", dependencies = TRUE)
library(astsa) # for ARIMA modelling
library(data.table)
library(dplyr)
library(forecast)
# Read data
aapl <- read.csv("data_files/AAPL_combined.csv.gz")
bep <- read.csv("data_files/BEP_combined.csv.gz")
lly <- read.csv("data_files/LLY_combined.csv.gz")
# Clean up columns
data_preprocess <- function(df){
output <- df %>%
rename("timestamp" = "Unnamed..0",
"open" = "X1..open",
"high" = "X2..high",
"low" = "X3..low",
"close" = "X4..close",
"volume" = "X5..volume")
return(output)
}
aapl <- data_preprocess(aapl)
bep <- data_preprocess(bep)
lly <- data_preprocess(lly)
# Add volatility
daily_volatility <- function(df){
output <- df %>%
select(timestamp, open, close) %>%
na.omit() %>%
mutate(date = as.Date(timestamp)) %>%
group_by(date) %>%
summarize(
open = first(open),
close = last(close)
) %>%
mutate(
log_return = log(1 + (close - open) / open),
volatility = sqrt(log_return)
) %>%
select(date, volatility)
}
aapl_vol <- daily_volatility(aapl)
bep_vol <- daily_volatility(bep)
lly_vol <- daily_volatility(lly)
vol_ts <- ts(aapl_vol$volatility, frequency = 252)  # ~252 trading days per year
fit <- auto.arima(vol_ts)
summary(fit)
forecast_vol <- forecast(fit, h = 30)
autoplot(forecast_vol)
aapl_vol_ts <- ts(aapl_vol$volatility, frequency = 252)  # ~252 trading days per year
aapl_fit <- auto.arima(aapl_vol_ts)
summary(aapl_fit)
forecast_aapl <- forecast(aapl_fit, h = 30)
autoplot(forecast_vol)
bep_vol_ts <- ts(bep_vol$volatility, frequency = 252)  # ~252 trading days per year
bep_fit <- auto.arima(bep_vol_ts)
summary(bep_fit)
forecast_bep <- forecast(bep_fit, h = 30)
autoplot(forecast_bep)
lly_vol_ts <- ts(lly_vol$volatility, frequency = 252)  # ~252 trading days per year
lly_fit <- auto.arima(lly_vol_ts)
summary(lly_fit)
forecast_lly <- forecast(lly_fit, h = 30)
autoplot(forecast_lly)
knitr::opts_chunk$set(echo = TRUE)
library(astsa)
mvspec(sunspotz, taper=0, log="no")
abline(v=3/240, lty="dashed") # 88 year cylces
abline(v=22/240, lty="dashed") # 11 year cycles
P = mvspec(sunspotz, taper=0, log="no")
abline(v=3/240, lty="dashed") # 88 year cycles
abline(v=22/240, lty="dashed") # 11 year cycles
c(2*P$spec[19]/qchisq(.975, 2), 2*P$spec[19]/qchisq(.025, 2))
P = mvspec(sunspotz, taper=0)
abline(v=3/240, lty="dashed") # 88 year cycles
abline(v=22/240, lty="dashed") # 11 year cycles
c(2*P$spec[19]/qchisq(.975, 2), 2*P$spec[19]/qchisq(.025, 2))
mvspec(sunspotz, taper=0)
abline(v=3/240, lty="dashed") # 88 year cycles
abline(v=22/240, lty="dashed") # 11 year cycles
#c(2*P$spec[19]/qchisq(.975, 2), 2*P$spec[19]/qchisq(.025, 2))
mvspec(sunspotz, taper=0)
#abline(v=3/240, lty="dashed") # 88 year cycles
#abline(v=22/240, lty="dashed") # 11 year cycles
#c(2*P$spec[19]/qchisq(.975, 2), 2*P$spec[19]/qchisq(.025, 2))
mvspec(sunspotz, taper=0, log="yes")
#abline(v=3/240, lty="dashed") # 88 year cycles
#abline(v=22/240, lty="dashed") # 11 year cycles
#c(2*P$spec[19]/qchisq(.975, 2), 2*P$spec[19]/qchisq(.025, 2))
mvspec(sunspotz, taper=0, log="no")
#abline(v=3/240, lty="dashed") # 88 year cycles
#abline(v=22/240, lty="dashed") # 11 year cycles
#c(2*P$spec[19]/qchisq(.975, 2), 2*P$spec[19]/qchisq(.025, 2))
P <- mvspec(sunspotz, taper=0, log="no")
#abline(v=3/240, lty="dashed") # 88 year cycles
#abline(v=22/240, lty="dashed") # 11 year cycles
#c(2*P$spec[19]/qchisq(.975, 2), 2*P$spec[19]/qchisq(.025, 2))
freqs <- P$freq   # in cycles per sample if mvspec used; interpret according to package docs
periods_years <- 1 / (freqs * 2)
k <- which.max(P$spec)   # likely the ~11-year cycle
I_k <- P$spec[k]
ci_lower <- 2 * I_k / qchisq(0.975, df=2)
ci_upper <- 2 * I_k / qchisq(0.025, df=2)
cat("Peak period (years):", periods_years[k], "\n")
cat("Spectrum I(omega):", I_k, "\n")
cat("Approx 95% CI for f(omega):", ci_lower, ci_upper, "\n")
P <- mvspec(sunspotz, taper=0, log="no")
#abline(v=3/240, lty="dashed") # 88 year cycles
#abline(v=22/240, lty="dashed") # 11 year cycles
#c(2*P$spec[19]/qchisq(.975, 2), 2*P$spec[19]/qchisq(.025, 2))
freqs <- P$freq
periods_years <- 1 / (freqs * 2)
k <- which.max(P$spec)
I_k <- P$spec[k]
ci_lower <- 2 * I_k / qchisq(0.975, df=2)
ci_upper <- 2 * I_k / qchisq(0.025, df=2)
cat("Cycle (years):", k, "\n")
cat("Peak period (years):", periods_years[k], "\n")
cat("Spectrum:", I_k, "\n")
cat("CI:", ci_lower, ci_upper, "\n")
P <- mvspec(sunspotz, taper=0, log="no")
#abline(v=3/240, lty="dashed") # 88 year cycles
#abline(v=22/240, lty="dashed") # 11 year cycles
#c(2*P$spec[19]/qchisq(.975, 2), 2*P$spec[19]/qchisq(.025, 2))
freqs <- P$freq
periods_years <- 1 / (freqs * 2)
k <- which.max(P$spec)
I_k <- P$spec[k]
ci_lower <- 2 * I_k / qchisq(0.975, df=2)
ci_upper <- 2 * I_k / qchisq(0.025, df=2)
cat("Cycle years):", k/2, "\n") #dividing by two to account for 2 samples per year
cat("Peak period (years):", periods_years[k], "\n")
cat("Spectrum:", I_k, "\n")
cat("CI:", ci_lower, ci_upper, "\n")
P <- mvspec(sunspotz, taper=0, log="no")
abline(v=22/240, lty="dashed", col="blue")
mtext("1/11", side=1, line=0, at=22/240, cex=0.75, col="blue")
abline(v=3/240, lty="dashed", col="red")
mtext("1/88", side=1, line=0, at=3/240, cex=0.75, col="red")
u = qchisq(0.025, 2)
l = qchisq(0.975, 2)
spec_11 <- P$spec[22]
ci_11 <- c(2 * spec_11 / l, 2 * spec_11 / u)
spec_88 <- P$spec[3]
ci_88 <- c(2 * spec_88 / l, 2 * spec_88 / u)
cat("11-Year Cycle Freq:", P$freq[22], "\n")
cat("  Spectrum Value:", spec_11, "\n")
cat("  95% CI: [", ci_11[1], ", ", ci_11[2], "]\n")
cat("88-Year Cycle Freq:", P$freq[3], "\n")
cat("  Spectrum Value:", spec_88, "\n")
cat("  95% CI: [", ci_88[1], ", ", ci_88[2], "]\n")
mvspec(salmon, log="no")
mvspec(salmon, log="no", taper=0)
mvspec(salmon, log="no", taper=1)
mvspec(salmon, log="no", taper=0.5)
mvspec(salmon, log="no", taper=0)
P <- mvspec(salmon, log="no", taper=0)
P <- mvspec(salmon, log="no", taper=0)
# Find the frequency with the maximum power (excluding index 1 which is frequency 0)
max_idx <- which.max(P$spec)
peak_freq <- P$freq[max_idx]
# Convert to Period (in months and years)
period_months <- 1 / peak_freq
period_years <- period_months / 12
# Output the finding
cat("Dominant Peak Frequency:", peak_freq, "cycles/month\n")
cat("Dominant Cycle Period:", period_months, "months ( approx", period_years, "years )")
P <- mvspec(salmon, log="no", taper=0)
abline(v=2, lty=2, col="red")
mtext("2 years", side=1, at=2/12, line=0, cex=0.7)
abline(v=4, lty=2, col="green")
mtext("4 years", side=1, at=3/12, line=0, cex=0.7)
P <- mvspec(salmon, log="no", taper=0)
spec.ar(sunspotz)
spec.ar(sunspotz)
(freq <- A$freq)
A <- spec.ar(sunspotz)
(freq <- A$freq)
(spec <- A$spec)
A <- spec.ar(sunspotz)
freq <- A$freq
spec <- A$spec
idx_11yr <- which.max(spec[freq > 0.05 & freq < 0.2])
peak_11yr_freq <- freq[freq > 0.05 & freq < 0.2][idx_11yr]
period_11yr <- 1 / peak_11yr_freq
idx_90yr <- which.max(spec[freq > 0.005 & freq < 0.02])
peak_90yr_freq <- freq[freq > 0.005 & freq < 0.02][idx_90yr]
period_90yr <- 1 / peak_90yr_freq
cat("--- AR Spectrum Peak Analysis ---\n")
cat("Schwabe Cycle (11-year neighborhood):\n")
cat("  Frequency:", peak_11yr_freq, "cycles/year\n")
cat("  Period:", period_11yr, "years\n\n")
cat("Gleissberg Cycle (90-year neighborhood):\n")
cat("  Frequency:", peak_90yr_freq, "cycles/year\n")
cat("  Period:", period_90yr, "years\n")
P <- spec.ar(sunspotz)
max_idx <- which.max(P$spec)
peak_freq <- P$freq[max_idx]
# Convert to Period (in months and years)
period_months <- 1 / peak_freq
period_years <- period_months / 12
# Output the finding
cat("Dominant Peak Frequency:", peak_freq, "cycles/month\n")
cat("Dominant Cycle Period:", period_months, "months ( approx", period_years, "years )")
freq <- P$freq
spec <- P$spec
# --- Step 2: Find the Top 1 Peak (Dominant Cycle) ---
# Filter out the very low frequency component (zero/trend)
# We start searching from freq > 0.005 cycles/year (periods less than 200 years)
search_range_start_index <- which(freq >= 0.005)[1]
filtered_spec <- spec[search_range_start_index:length(spec)]
filtered_freq <- freq[search_range_start_index:length(freq)]
# Find the maximum power index in the filtered range
max_idx_p1_filtered <- which.max(filtered_spec)
peak1_freq <- filtered_freq[max_idx_p1_filtered]
peak1_period <- 1 / peak1_freq
# --- Step 3: Find the Top 2 Peak (Secondary Cycle) ---
# Define the neighborhood (width) around the first peak to exclude,
# e.g., +/- 0.01 cycles/year. This prevents selecting the same peak twice.
exclusion_width <- 0.01
# Find the indices corresponding to the neighborhood of the first peak
exclusion_indices <- which(filtered_freq >= peak1_freq - exclusion_width &
filtered_freq <= peak1_freq + exclusion_width)
# Temporarily set the spectrum values in the neighborhood to zero
filtered_spec_temp <- filtered_spec
filtered_spec_temp[exclusion_indices] <- 0
# Find the new maximum power index (Peak 2)
max_idx_p2_filtered <- which.max(filtered_spec_temp)
peak2_freq <- filtered_freq[max_idx_p2_filtered]
peak2_period <- 1 / peak2_freq
# --- Step 4: Output the results ---
cat("--- Top 2 AR Spectrum Peak Analysis ---\n")
cat("1st Dominant Cycle (Highest Power):\n")
cat("  Frequency (cycles/year):", peak1_freq, "\n")
cat("  Period (years):", peak1_period, "\n\n")
cat("2nd Dominant Cycle (Next Highest Power):\n")
cat("  Frequency (cycles/year):", peak2_freq, "\n")
cat("  Period (years):", peak2_period, "\n")
P <- spec.ar(sunspotz)
max_idx <- which.max(P$spec)
peak_freq <- P$freq[max_idx]
# Convert to Period (in months and years)
period_months <- 1 / peak_freq
period_years <- period_months / 12
# Output the finding
cat("Dominant Peak Frequency:", peak_freq, "cycles/month\n")
cat("Dominant Cycle Period:", period_months)
max(P$spec)
order(P$spec, decreasing = TRUE)[1:2]
x <- P$spec
local_max_idx <- which(x > c(-Inf, x[-length(x)]) &
x > c(x[-1], -Inf))
# take top 2 by value
top2_local_max_idx <- local_max_idx[order(x[local_max_idx], decreasing = TRUE)][1:2]
top2_local_max_idx
P$freq[1]
P$freq[49]
top2_local_max_idx[1]
P <- spec.ar(sunspotz)
local_max_idx <- which(P$spec > c(-Inf, P$spec[-length(P$spec)]) & P$spec > c(P&spec[-1], -Inf))
P <- spec.ar(sunspotz)
spec <- P$spec
local_max_idx <- which(spec > c(-Inf, spec[-length(spec)]) & spec > c(spec[-1], -Inf))
# take top 2 by value
top2_local_max_idx <- local_max_idx[order(spec[local_max_idx], decreasing = TRUE)][1:2]
peak_freq <- P$freq[top2_local_max_idx[1]]
peak_freq2 <- P$freq[top2_local_max_idx[2]]
# Convert to Period (in months and years)
period_months <- 1 / peak_freq
period_years <- period_months / 12
# Output the finding
cat("Dominant Peak Frequency:", 1/peak_freq/12)
cat("Secondary Peak Frequency: ", 1/peak_freq2/12))
P <- spec.ar(sunspotz)
spec <- P$spec
local_max_idx <- which(spec > c(-Inf, spec[-length(spec)]) & spec > c(spec[-1], -Inf))
# take top 2 by value
top2_local_max_idx <- local_max_idx[order(spec[local_max_idx], decreasing = TRUE)][1:2]
peak_freq <- P$freq[top2_local_max_idx[1]]
peak_freq2 <- P$freq[top2_local_max_idx[2]]
# Convert to Period (in months and years)
period_months <- 1 / peak_freq
period_years <- period_months / 12
# Output the finding
cat("Dominant Peak Frequency:", 1/peak_freq/12)
cat("Secondary Peak Frequency:", 1/peak_freq2/12)
P <- spec.ar(sunspotz)
spec <- P$spec
local_max_idx <- which(spec > c(-Inf, spec[-length(spec)]) & spec > c(spec[-1], -Inf))
# take top 2 by value
top2_local_max_idx <- local_max_idx[order(spec[local_max_idx], decreasing = TRUE)][1:2]
peak_freq <- P$freq[top2_local_max_idx[1]]
peak_freq2 <- P$freq[top2_local_max_idx[2]]
# Convert to Period (in months and years)
period_months <- 1 / peak_freq
period_years <- period_months / 12
# Output the finding
cat("Dominant Peak Frequency:", 1/peak_freq/12, "\n")
cat("Secondary Peak Frequency:", 1/peak_freq2/12)
P <- spec.ar(sunspotz)
spec <- P$spec
local_max_idx <- which(spec > c(-Inf, spec[-length(spec)]) & spec > c(spec[-1], -Inf))
# take top 2 by value
top2_local_max_idx <- local_max_idx[order(spec[local_max_idx], decreasing = TRUE)][1:2]
peak_freq <- P$freq[top2_local_max_idx[1]]
peak_freq2 <- P$freq[top2_local_max_idx[2]]
# Convert to Period (in months and years)
period_months <- 1 / peak_freq
period_years <- period_months / 12
# Output the finding
cat("Dominant Peak Frequency:", peak_freq/12, "\n")
cat("Secondary Peak Frequency:", peak_freq2/12)
P <- spec.ar(sunspotz)
spec <- P$spec
local_max_idx <- which(spec > c(-Inf, spec[-length(spec)]) & spec > c(spec[-1], -Inf))
# take top 2 by value
top2_local_max_idx <- local_max_idx[order(spec[local_max_idx], decreasing = TRUE)][1:2]
peak_freq <- P$freq[top2_local_max_idx[1]]
peak_freq2 <- P$freq[top2_local_max_idx[2]]
# Output the finding
cat("Dominant Peak Frequency:", peak_freq, "\n")
cat("Secondary Peak Frequency:", peak_freq2)
1/91
P$order
fit <- ar(sunspotz, method = "mle")
# AR spectral estimate using astsa-style spec.ar
P <- spec.ar(fit, plot = TRUE)
fit$order
fit <- ar(sunspotz, method="mle")
P <- spec.ar(fit, plot=FALSE)
# The long-term trend corresponds to low-frequency energy in the spectrum.
# To visualize in time domain:
trend <- astsa::lpfilter(sunspotz, cutoff = 0.05)  # <= 0.05 cycles/year
fit <- ar(sunspotz, method="mle")
P <- spec.ar(fit, plot=FALSE)
# long-term smoothed trend (25-year moving average)
trend <- filter(sunspotz, rep(1/25, 25), sides = 2)
plot(sunspotz, col="gray", main="Sunspots with Long-Term Trend")
lines(trend, col=2, lwd=2)
fit <- ar(sunspotz, method="mle")
P <- spec.ar(fit, plot=FALSE)
trend <- filter(sunspotz, rep(1/50, 50), sides = 2)
plot(sunspotz)
lines(trend, col=2, lwd=2)
fit <- ar(sunspotz, method="mle")
P <- spec.ar(fit, plot=FALSE)
# long-term trend (slow)
trend <- filter(sunspotz, rep(1/50, 50), sides=2)
# cycle = data minus trend
cycle <- sunspotz - trend
ts.plot(cbind(sunspotz, trend, cycle),
col=c("black","red","blue"),
lwd=c(1,2,2),
main="Sunspot: Data, Trend, and Cycle")
legend("topleft", legend=c("data","trend","cycle"),
col=c("black","red","blue"), lwd=2)
fit <- ar(sunspotz, method="mle")
P <- spec.ar(fit, plot=FALSE)
fit <- ar(sunspotz, method="mle")
P <- spec.ar(fit, plot=TRUE)
fit <- ar(sunspotz, method="mle")
P <- spec.ar(fit, plot=TRUE)
# find peaks in the spectrum
spec  <- P$spec
freq  <- P$freq
# indices of top 2 spectral peaks
top2_idx <- order(spec, decreasing = TRUE)[1:2]
# primary and secondary frequencies
primary_freq   <- freq[top2_idx[1]]
secondary_freq <- freq[top2_idx[2]]
# convert to periods (in years)
primary_period   <- 1 / primary_freq
secondary_period <- 1 / secondary_freq
(primary_period)
(secondary_period)
